<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>手机版跑酷游戏</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #87CEEB;
    overflow: hidden;
    touch-action: none; /* 防止双击放大 */
  }
  canvas {
    display: block;
    margin: 0 auto;
    background: #cceeff;
  }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

function resizeCanvas() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

let speed = 5;
let gravity = 0.5;
let frame = 0;
let score = 0;
let gameOver = false;
let invincible = false;
let invincibleTimer = 0;
let doubleJumpUsed = false;

// 玩家
let groundY = canvas.height - 50;
let player = { x: 50, y: groundY - 40, width: 40, height: 40, dy: 0, jumpPower: -12, grounded: true };

// 障碍物 & 道具
let obstacles = [];
let coins = [];
let stars = [];

function drawBackground() {
  ctx.fillStyle = "#87CEEB";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "#228B22";
  ctx.fillRect(0, groundY, canvas.width, 50);
}

function drawPlayer() {
  ctx.fillStyle = invincible ? "gold" : "blue";
  ctx.fillRect(player.x, player.y, player.width, player.height);
}

function drawObstacles() {
  ctx.fillStyle = "red";
  obstacles.forEach(o => ctx.fillRect(o.x, o.y, o.width, o.height));
}

function drawCoins() {
  ctx.fillStyle = "yellow";
  coins.forEach(c => {
    ctx.beginPath();
    ctx.arc(c.x, c.y, c.radius, 0, Math.PI * 2);
    ctx.fill();
  });
}

function drawStars() {
  ctx.fillStyle = "purple";
  stars.forEach(s => {
    ctx.beginPath();
    ctx.arc(s.x, s.y, s.radius, 0, Math.PI * 2);
    ctx.fill();
  });
}

function updatePlayer() {
  player.y += player.dy;
  player.dy += gravity;
  if (player.y >= groundY - player.height) {
    player.y = groundY - player.height;
    player.dy = 0;
    player.grounded = true;
    doubleJumpUsed = false;
  }
}

function updateObstacles() {
  obstacles.forEach(o => o.x -= speed);
  obstacles = obstacles.filter(o => o.x + o.width > 0);
  if (frame % 120 === 0) {
    let height = Math.random() < 0.5 ? 30 : 60;
    obstacles.push({ x: canvas.width, y: groundY - height, width: 20, height: height });
  }
}

function updateCoins() {
  coins.forEach(c => c.x -= speed);
  coins = coins.filter(c => c.x + c.radius > 0);
  if (frame % 80 === 0) {
    coins.push({ x: canvas.width, y: groundY - 40, radius: 8 });
  }
}

function updateStars() {
  stars.forEach(s => s.x -= speed);
  stars = stars.filter(s => s.x + s.radius > 0);
  if (frame % 300 === 0) {
    stars.push({ x: canvas.width, y: groundY - 60, radius: 10 });
  }
}

function checkCollision() {
  for (let o of obstacles) {
    if (player.x < o.x + o.width &&
        player.x + player.width > o.x &&
        player.y < o.y + o.height &&
        player.y + player.height > o.y) {
      if (!invincible) gameOver = true;
    }
  }
  coins.forEach((c, i) => {
    if (Math.hypot(player.x - c.x, player.y - c.y) < 30) {
      score += 50;
      coins.splice(i, 1);
    }
  });
  stars.forEach((s, i) => {
    if (Math.hypot(player.x - s.x, player.y - s.y) < 30) {
      invincible = true;
      invincibleTimer = 300;
      stars.splice(i, 1);
    }
  });
}

function drawScore() {
  ctx.fillStyle = "black";
  ctx.font = `${Math.floor(canvas.width / 30)}px Arial`;
  ctx.fillText("Score: " + score, 10, 30);
}

function gameLoop() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (!gameOver) {
    frame++;
    score++;
    if (frame % 600 === 0) speed += 0.5;
    if (invincible) {
      invincibleTimer--;
      if (invincibleTimer <= 0) invincible = false;
    }
    drawBackground();
    updatePlayer();
    updateObstacles();
    updateCoins();
    updateStars();
    checkCollision();
    drawPlayer();
    drawObstacles();
    drawCoins();
    drawStars();
    drawScore();
    requestAnimationFrame(gameLoop);
  } else {
    ctx.fillStyle = "black";
    ctx.font = `${Math.floor(canvas.width / 15)}px Arial`;
    ctx.fillText("Game Over", canvas.width / 2 - 100, canvas.height / 2);
    ctx.font = `${Math.floor(canvas.width / 25)}px Arial`;
    ctx.fillText("Score: " + score, canvas.width / 2 - 50, canvas.height / 2 + 40);
  }
}

// 手机触控跳跃
document.addEventListener("touchstart", () => {
  if (player.grounded) {
    player.dy = player.jumpPower;
    player.grounded = false;
  } else if (!doubleJumpUsed) {
    player.dy = player.jumpPower;
    doubleJumpUsed = true;
  }
});

gameLoop();
</script>
</body>
</html>